<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="style.css" />
    <script type="text/javascript" src="Solver.js"></script>
    <script type="text/javascript" src="CogInventory.js"></script>
    <script type="text/javascript" src="BoardRenderer.js"></script>
    <script type="text/javascript" src="Paginator.js"></script>
    
    <title>Cogtimizer</title>
  </head>
  <body>
    <div class="menucontainer">
      <ul class="menu">
        <li id="loaderbtn" class="active"><div><div><div>Loader</div></div></div></li>
        <li id="cogbtn"><div><div><div>Cogs</div></div></div></li>
      </ul>
      <div class="options">
        <button id="settingsbtn">
          <div></div>
          <div>
            Settings
            <div class="checkbox"></div>
          </div>
          <div></div>
        </button>
        <button id="solve" >
          <div></div>
          <div id="solvetext">Solve</div>
          <div></div>
        </button>
      </div>
      <div class="spacer"></div>
      <div class="crow"></div>
    </div>
    <div class="content">
      <div id="loader">
      <div class="inputarea">
        <div>Enter config json or username</div>
        <textarea type="textarea" id="input" rows="10" cols="100"></textarea>
        <div>
          <button id="load" style="max-width: 15ch;">Load</button>
        </div>
      </div>
    </div>
      <div id="result">
        <div id="notify">
          <span>Please</span>
          <span>load</span>
          <span>a</span>
          <span>savegame</span>
        </div>
        <div class="info">
          <div id="spare">---Placeholder---</div>
          <div id="sparepage"></div>
          <div class="stats">
            <span class="buildrate">
              <h3>Total Build Rate</h3>
              <p id="buildrate">N/A</p>
            </span>
            <span class="xpbonus">
              <h3>Player XP Bonus</h3>
              <p id="xpbonus">N/A</p>
            </span>
            <span class="flaggyrate">
              <h3>Flaggy Rate</h3>
              <p id="flaggyrate">N/A</p>
            </span>
          </div>
        </div>
        <div class="border" id="border"></div>
        <div id="settings" style="display: none;">
          <p>
            <label for="flaggyShop">Gem Shop Flaggy upgrades</label><br />
            <input type="number" id="flaggyShop" value="0" style="width:6ch" disabled=true></input>
          </p>
          <p>
            <label for="buildRate">Build rate score weight</label><br />
            <input type="number" id="buildRate" value="2" style="width:6ch"></input>
          </p>
          <p>
            <label for="expBonus">EXP Bonus score weight</label><br />
            <input type="number" id="expBonus" value="50" style="width:6ch"></input>
          </p>
          <p>
            <label for="flaggy">Flaggy rate score weight</label><br />
            <input type="number" id="flaggy" value="5" style="width:6ch"></input>
          </p>
          <p>
            <label for="solveTime">Solve times (ms)</label><br />
            <input type="number" id="solveTime" value="1000" style="width:10ch"></input>
          </p>
        </div>
        <div id="currentBoard">
        </div>
        <div id="steps"></div>
      </div>
    </div>
    <p id="start"></p>
    <p id="end"></p>
    <script type="text/javascript">
      const ROWS = 8;
      const COLUMNS = 12;
      const OPTIMIZABLE = ["buildRate", "expBonus", "flaggy"];
      
      const getInput = (id) => Number.parseInt(document.getElementById(id).value);
      const getFlaggyShop = getInput.bind(null, "flaggyShop");

      const createElem = function createElem(tagName, style=undefined) {
        const elem = document.createElement(tagName);
        if (style) {
          elem.style = style;
        }
        return elem;
      }
      
      window.g = {
        cogs: {},
        board: [],
        best: null
      };
      window.f = {};

      window.boardRenderer = new BoardRenderer(ROWS, COLUMNS, "board");
      window.spareRenderer = new BoardRenderer(40, 3, "spare", 5);
      window.solver = new Solver();
      window.cogInvetory = new CogInventory();

      window.sparePage = new Paginator("sparepage", window.spareRenderer._pageCount, 1);
      window.sparePage.addEventListener("change", (ev) => {
        window.spareRenderer.showPage(ev.page);
      });

      const boardElem = document.getElementById("currentBoard");
      boardElem.innerHTML = "";
      // boardElem.appendChild(table);
      boardElem.appendChild(window.boardRenderer.createHTMLElement());

      const stepContainer = createElem("div");
      stepContainer.id = "stepspage";
      boardElem.appendChild(stepContainer);
      const stepsPage = new Paginator("stepspage", 0, 0, "Step");
      stepsPage.addEventListener("change", console.log);

      const spareElem = document.getElementById("spare");
      const spareParent = spareElem.parentNode;
      spareParent.insertBefore(window.spareRenderer.createHTMLElement(), spareElem);
      spareParent.removeChild(spareElem);

      const settingsBtn = document.getElementById("settingsbtn");
      const slider = settingsBtn.childNodes[3].childNodes[1];
      const settingsPage = document.getElementById("settings");
      const borderElem = document.getElementById("border");
      settingsBtn.addEventListener("click", () => {
        const active = slider.classList.contains("active");
        if (active) {
          slider.classList.remove("active");
          settingsPage.style.display = "none";
        } else {
          slider.classList.add("active");
          settingsPage.style.display = "";
          settingsPage.style.left = borderElem.offsetLeft + "px";
          settingsPage.style.height = borderElem.offsetHeight + "px";
        }
      })
      
      f.verifyBoardIntegrity = (board) => {
        for (let y = 0; y < board.length; y++) {
          for (let x = 0; x < board[y].length; x++) {
            if (board[y][x].blocked) continue;
            const tempPos = board[y][x].position();
            if (tempPos.x !== x || tempPos.y !== y) {
              debugger;
            }
          }
        }
      }

      let moveIndex = 0;
      //TODO Paddy: Kann so schlecht resettet werden (und wird aktuell nicht genutzt)
      let moves = [];
      
      f.printMove = (board, cog1, cog2, pos1, pos2) => {
        const prevMoves = [...moves];
        moves.push({pos1: cog1.key, pos2: cog2.key});
        const toAdd = createElem("p");
        toAdd.innerHTML = `Switch ${pos1.location} \
        [${pos1.x + 1}|${pos1.y + 1}] \
        (${cog1.buildRate || 0}:${cog1.expBonus || 0}:${cog1.flaggy || 0}) <span style="background-image:url('icons/cogs/${cog1.icon}.png')"></span> with \
        ${pos2.location} \
        [${pos2.x + 1}|${pos2.y + 1}] \
        (${cog2.buildRate || 0}:${cog2.expBonus || 0}:${cog2.flaggy || 0}) <span style="background-image:url('icons/cogs/${cog2.icon}.png')"></span>`;
        toAdd.onclick = () => {
          const clone = cogInvetory.clone();
          for (const m of prevMoves) {
            clone.move(m.pos1, m.pos2);
          }
          // TODO Paddy: clone is now in the state _before_ the move, that should be displayed with the 2 positions highlighted.
          f.printBoard(clone.board);
          window.boardRenderer.move(pos1, pos2);

          if (pos1.location == "spare" || pos2.location == "spare") {
            let pos = pos1;
            if (pos2.location == "spare") {
              pos = pos2;
            }
            const page = window.spareRenderer.getPage(pos);
            if (page != -1) {
              sparePage.goto(page);
            }
          }

          window.spareRenderer.move(pos1, pos2);
        }
        document.getElementById("steps").appendChild(toAdd);
      }
      
      f.printBoard = (board, cord1={},cord2={}) => {
        for (let i = 0; i < board.length; i++) {
          const row = createElem("tr");
          
          for (let j = 0; j < board[i].length; j++) {
            window.boardRenderer.set(i, j, board[i][j]);
          }
        }

        console.log("Board updated");
      }
      
      function yield() {
        return new Promise(r=>setTimeout(r,1));
      }
      
      f.printOptimalSteps = (board, cogs) => {
        moves = [];
        document.getElementById("steps").innerHTML = "";
        const cogsToMove = Object.values(cogs).map(c=>{return new Cog(c)})
          .filter((c) => c.key !== c.initialKey);
        const interimCogs = {};
        for (const cog of cogsToMove) {
          interimCogs[cog.initialKey] = cog;
        }
        // Multi-step movements
        let tuple;
        while (tuple = Object.entries(interimCogs)[0]) {
          const [key, cog] = tuple;
          const targetCog = interimCogs[cog.key];
          if (targetCog === cog) {
            delete interimCogs[key];
            continue;
          }
          interimCogs[key] = targetCog;
          f.printMove(board, cog, targetCog, cog.position(Number.parseInt(key)), targetCog.position(Number.parseInt(cog.key)));
          delete interimCogs[cog.key];
        }
      }

      function mmoifyNumber(num, addSign = true) {
        let str = num;

        if (Math.abs(num) >= 1000000) {
          str = (Math.ceil(num / 10000) / 100) + "M";
        } else if (Math.abs(num) >= 1000) {
          str = (Math.ceil(num / 10) / 100) + "K";
        }

        if (addSign && num >= 0) {
          str = "+" + str;
        }

        return str.toString();
      }

      function load(save) {
        cogInvetory.load(save);
        console.log("Loading");
        // Fetch Gem-Shop flaggy upgrades
        document.getElementById("flaggyShop").value = cogInvetory.flaggyShopUpgrades;
        sparePage.goto(0);
        for (let i = 108; i < 200; i++) {
          if (!cogInvetory.cogs[i]) continue;
          const index = (i - 108);
          const row = Math.floor(index / 3); // 3 since the spare board has 3 columns per row
          const col = index % 3;
          window.spareRenderer.set(row, col, cogInvetory.cogs[i]);
        };

        const initScore = cogInvetory.score;
        f.printBoard(cogInvetory.board);

        document.getElementById("solve").disabled = "";
        document.getElementById("steps").innerHTML = "";
        document.getElementById("buildrate").innerText = mmoifyNumber(initScore.buildRate, false) + "/HR";
        document.getElementById("xpbonus").innerText = mmoifyNumber(initScore.expBonus, false) + "%";
        document.getElementById("flaggyrate").innerText = mmoifyNumber(initScore.flaggy, false) + "/HR";

        openCogTab();
      }
      
      function fetchAndLoadConfig(username) {
        console.log("Trying to fetch", username);
        if (username.length > 0) {
          const headers = {
            "Content-Type": "text/json",
            method: "GET"
          };
          fetch(`https://cdn.idleonefficiency.com/profiles/${username.toLowerCase()}.json`, headers)
          .then((response) => {
            return response.json();
          }).then((json) => {
            load(json);
          }).catch((reason) => {
            console.log(reason);
          })
        }
      }

      document.getElementById("load").addEventListener("click", () => {
        const input = document.getElementById("input").value;
        try {
          const save = JSON.parse(input);
          load(save);
        } catch (e) {
          if (e instanceof SyntaxError) {
            fetchAndLoadConfig(input);
          }
        }
      });
      
      document.getElementById("solve").onclick = async () => {
        const solveTime = getInput("solveTime") || 2500;
        document.getElementById("solvetext").innerText = "Optimizing...";
        document.getElementById("steps").innerHTML = "";
        let lastYield = Date.now();
        await yield(); // Yield for DOM-Refresh

        console.log("Starting");

        let start = cogInvetory.clone();

        document.getElementById("start").innerText = `Starting BuildRate: ${start.score.buildRate}, EXP: ${start.score.expBonus}, Flaggy: ${start.score.flaggy}`;
        solver.setWeights(getInput("buildRate"), getInput("expBonus"), getInput("flaggy"));
        const best = await solver.solve(cogInvetory, solveTime);
        document.getElementById("end").innerText = `Final BuildRate: ${best.score.buildRate}, EXP: ${best.score.expBonus}, Flaggy: ${best.score.flaggy}`;
        
        document.getElementById("buildrate").innerText = `${mmoifyNumber(best.score.buildRate - start.score.buildRate)}/HR`;
        document.getElementById("xpbonus").innerText = `${mmoifyNumber(best.score.expBonus - start.score.expBonus)}%`;
        document.getElementById("flaggyrate").innerText = `${mmoifyNumber(best.score.flaggy - start.score.flaggy)}/HR`;
        
        f.printOptimalSteps(best.board, best.cogs);
        // f.printBoard(best.board);
        // TODO Paddy: This opens the original board, not the board after solving
        openCogTab();
        document.getElementById("solvetext").innerText = "Solve";
      };
    
      function openCogTab() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("result").style.display = "inherit";

        document.getElementById("loaderbtn").className = "";
        document.getElementById("cogbtn").className = "active";
      }

      function openLoaderTab() {
        document.getElementById("loader").style.display = "inherit";
        document.getElementById("result").style.display = "none";

        document.getElementById("loaderbtn").className = "active";
        document.getElementById("cogbtn").className = "";
      }

      document.getElementById("loaderbtn").addEventListener("click", () => {
        openLoaderTab();
      });
      document.getElementById("cogbtn").addEventListener("click", () => {
        openCogTab();
      });
    </script>
  </body>
</html>